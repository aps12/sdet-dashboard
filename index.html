<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; }
        .sidebar-item { transition: all 0.2s; }
        .sidebar-item:hover, .sidebar-item.active { background-color: #0f172a; color: white; }
        .card { background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .status-checkbox { width: 1.2rem; height: 1.2rem; cursor: pointer; }
        .group-header { background-color: #f1f5f9; color: #475569; font-weight: 700; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; padding: 10px 15px; }
        
        /* Spinner */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-slate-800">

    <aside class="w-64 bg-slate-900 text-slate-300 flex flex-col justify-between hidden md:flex">
        <div>
            <div class="p-6 flex items-center gap-3 text-white font-bold text-xl tracking-wide">
                <i class="ph-fill ph-code-block text-emerald-400"></i>
                <span>Custom Planner<span class="text-emerald-400"></span></span>
            </div>
            <nav class="px-4 space-y-1">
                <button onclick="router('dashboard')" id="nav-dashboard" class="sidebar-item active w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium">
                    <i class="ph ph-squares-four text-lg"></i> Dashboard
                </button>
                <button onclick="router('dsa')" id="nav-dsa" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium">
                    <i class="ph ph-brackets-curly text-lg"></i> 90-Day DSA
                </button>
                <button onclick="router('projects')" id="nav-projects" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium">
                    <i class="ph ph-kanban text-lg"></i> Client Work
                </button>
                <button onclick="router('epam')" id="nav-epam" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium">
                    <i class="ph ph-briefcase text-lg"></i> EPAM / Personal
                </button>
                <button onclick="router('learning')" id="nav-learning" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium">
                    <i class="ph ph-certificate text-lg"></i> Certs / Learning
                </button>
                <button onclick="router('health')" id="nav-health" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium">
                    <i class="ph ph-heartbeat text-lg"></i> Routine
                </button>
            </nav>
        </div>
        <div class="p-4 border-t border-slate-700">
            <div class="flex items-center gap-2 justify-center text-xs text-slate-400 mb-2">
                <div id="sync-status-icon" class="w-2 h-2 rounded-full bg-red-500"></div>
                <span id="sync-status-text">Disconnected</span>
            </div>
            <div class="text-[10px] text-center text-slate-500">
                Powered by Firebase
            </div>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto p-4 md:p-8 relative bg-slate-50">
        
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-2xl font-bold text-slate-900" id="page-title">Overview</h1>
                <p class="text-slate-500 text-sm" id="current-date">Loading...</p>
            </div>
            <div id="loading-spinner" class="hidden"><div class="loader"></div></div>
        </header>

        <div id="view-dashboard" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="card p-5 bg-slate-800 text-white border-none relative overflow-hidden"><div class="relative z-10"><div class="text-slate-300 text-xs font-bold uppercase tracking-wider">Overall Completion</div><div class="text-3xl font-bold mt-2" id="stat-progress">0%</div></div></div>
                <div class="card p-5 border-l-4 border-emerald-500"><div class="text-slate-500 text-xs font-bold uppercase tracking-wider">DSA Progress</div><div class="text-3xl font-bold mt-2 text-slate-800" id="stat-dsa">0/90</div></div>
                <div class="card p-5 border-l-4 border-blue-500"><div class="text-slate-500 text-xs font-bold uppercase tracking-wider">Client Work</div><div class="text-3xl font-bold mt-2 text-slate-800" id="stat-client-pct">0%</div></div>
                <div class="card p-5 border-l-4 border-pink-500"><div class="text-slate-500 text-xs font-bold uppercase tracking-wider">EPAM / Personal</div><div class="text-3xl font-bold mt-2 text-slate-800" id="stat-epam-pct">0%</div></div>
                <div class="card p-5 border-l-4 border-purple-500"><div class="text-slate-500 text-xs font-bold uppercase tracking-wider">Certifications</div><div class="text-3xl font-bold mt-2 text-slate-800" id="stat-cert-pct">0%</div></div>
                <div class="card p-5 border-l-4 border-orange-500"><div class="text-slate-500 text-xs font-bold uppercase tracking-wider">Consistency Streak</div><div class="text-3xl font-bold mt-2 text-slate-800" id="stat-streak">0 Days</div></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card p-6 h-80 flex flex-col"><h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="ph-fill ph-warning-circle text-orange-500"></i> High Priority Focus</h3><div id="focus-list" class="space-y-2 overflow-y-auto flex-1 pr-2"></div></div>
                <div class="card p-6 h-80"><h3 class="font-bold text-slate-700 mb-2">Effort Split</h3><div class="h-full pb-6"><canvas id="chart-domain"></canvas></div></div>
            </div>
        </div>

        <div id="view-dsa" class="hidden space-y-6">
            <div class="card p-6">
                <div class="flex justify-between items-center mb-6"><div><h2 class="text-xl font-bold text-slate-800">90-Day SDET Roadmap</h2></div><div class="flex gap-4 items-center"><div class="text-2xl font-bold text-emerald-600" id="dsa-progress-text">0%</div><button onclick="openAddDSAModal()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-emerald-700 flex items-center gap-2">+ Problem</button></div></div>
                <div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead><tr class="text-slate-400 text-xs uppercase tracking-wider border-b"><th class="p-3 w-20">Day</th><th class="p-3 w-1/4">Topic</th><th class="p-3">Problem</th><th class="p-3 w-24">Priority</th><th class="p-3 w-16 text-center">Edit</th><th class="p-3 w-16 text-center">Done</th></tr></thead><tbody id="dsa-tbody" class="text-sm"></tbody></table></div>
            </div>
        </div>

        <div id="view-projects" class="hidden space-y-6"><div class="flex justify-between items-center"><h2 class="text-xl font-bold">Client Work</h2><button onclick="openProjectModal('Work')" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">+ Project</button></div><div id="container-Work" class="grid grid-cols-1 gap-6 mt-4"></div></div>
        <div id="view-epam" class="hidden space-y-6"><div class="flex justify-between items-center"><h2 class="text-xl font-bold text-pink-700">EPAM / Personal</h2><button onclick="openProjectModal('Epam')" class="bg-pink-600 text-white px-4 py-2 rounded-lg text-sm">+ New Project</button></div><div id="container-Epam" class="grid grid-cols-1 gap-6 mt-4"></div></div>
        <div id="view-learning" class="hidden space-y-6"><div class="flex justify-between items-center"><h2 class="text-xl font-bold text-purple-700">Certifications</h2><button onclick="openProjectModal('Learning')" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm">+ Cert</button></div><div id="container-Learning" class="grid grid-cols-1 gap-6 mt-4"></div></div>
        <div id="view-health" class="hidden space-y-6"><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="card p-6 col-span-1 border-t-4 border-emerald-500"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg">Today</h3><button onclick="openRoutineModal()" class="text-xs bg-slate-100 px-2 py-1 rounded">Edit</button></div><div id="health-today-list" class="space-y-1"></div><button onclick="saveHealthDay()" class="mt-6 w-full bg-slate-900 text-white py-3 rounded-lg font-bold">Complete Day</button></div><div class="card p-6 col-span-2"><h3 class="font-bold text-lg mb-4">Log</h3><div class="overflow-y-auto max-h-96"><table class="w-full text-sm"><tbody id="health-history-body"></tbody></table></div></div></div></div>
    </main>

    <div id="modal-dsa" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50"><div class="bg-white rounded-xl p-6 w-96 shadow-2xl"><h3 class="text-lg font-bold mb-4" id="modal-dsa-title">Problem</h3><input type="hidden" id="dsa-id"><label class="text-xs font-bold uppercase">Day</label><input type="number" id="dsa-day" class="w-full border p-2 rounded mb-2"><label class="text-xs font-bold uppercase">Topic</label><input type="text" id="dsa-topic" class="w-full border p-2 rounded mb-2"><label class="text-xs font-bold uppercase">Name</label><input type="text" id="dsa-name" class="w-full border p-2 rounded mb-2"><label class="text-xs font-bold uppercase">Link</label><input type="text" id="dsa-link" class="w-full border p-2 rounded mb-2"><label class="text-xs font-bold uppercase">Priority</label><select id="dsa-priority" class="w-full border p-2 rounded mb-4"><option>Low</option><option>Medium</option><option>High</option></select><div class="flex gap-2 justify-end"><button onclick="closeModal('modal-dsa')" class="px-4 text-slate-600">Cancel</button><button onclick="saveDSA()" class="px-4 py-2 bg-emerald-600 text-white rounded">Save</button></div></div></div>
    <div id="modal-project" class="fixed inset-0 bg-black bg-opacity-40 hidden flex items-center justify-center z-50"><div class="bg-white rounded-xl p-6 w-96"><h3 class="text-lg font-bold mb-4">New Project</h3><input type="hidden" id="modal-p-type"><input type="text" id="modal-p-title" class="w-full border p-2 rounded mb-4" placeholder="Title"><div class="flex gap-2 justify-end"><button onclick="closeModal('modal-project')" class="px-4 text-slate-600">Cancel</button><button onclick="saveProject()" class="px-4 py-2 bg-blue-600 text-white rounded">Create</button></div></div></div>
    <div id="modal-subtask" class="fixed inset-0 bg-black bg-opacity-40 hidden flex items-center justify-center z-50"><div class="bg-white rounded-xl p-6 w-96"><h3 class="text-lg font-bold mb-4">Add Subtask</h3><input type="hidden" id="modal-s-parent"><input type="text" id="modal-s-title" class="w-full border p-2 rounded mb-3" placeholder="Name"><select id="modal-s-priority" class="w-full border p-2 rounded mb-4"><option>Low</option><option>Medium</option><option>High</option></select><div class="flex gap-2 justify-end"><button onclick="closeModal('modal-subtask')" class="px-4 text-slate-600">Cancel</button><button onclick="saveSubtask()" class="px-4 py-2 bg-blue-600 text-white rounded">Add</button></div></div></div>
    <div id="modal-routine" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50"><div class="bg-white rounded-xl p-6 w-full max-w-lg h-[80vh] flex flex-col"><h3 class="text-lg font-bold mb-4">Edit Routine</h3><div id="routine-editor-list" class="flex-1 overflow-y-auto space-y-2 mb-4"></div><button onclick="addRoutineItem()" class="w-full py-2 border border-dashed text-slate-500 rounded mb-4">+ Add Step</button><div class="flex gap-2 justify-end pt-4 border-t"><button onclick="closeModal('modal-routine')" class="px-4 py-2 text-slate-600">Cancel</button><button onclick="saveRoutineEdit()" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- PASTE YOUR FIREBASE KEYS BELOW ---
        // If you don't have keys yet, leave this as is. The app will auto-fallback to LocalStorage.
        const firebaseConfig = {
							  apiKey: "AIzaSyDSeqlg_QIEzHx2n15GcOP5jgKZzQ_MzZg",
							  authDomain: "sdet-dashboard.firebaseapp.com",
							  databaseURL: "https://sdet-dashboard-default-rtdb.firebaseio.com",
							  projectId: "sdet-dashboard",
							  storageBucket: "sdet-dashboard.firebasestorage.app",
							  messagingSenderId: "917849703698",
							  appId: "1:917849703698:web:764162e0198e5cf9439fcb"
							};
        // ----------------------------------------

        let app, db;
        let firebaseActive = false;

        // Try to Connect to Firebase
        try {

            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            firebaseActive = true;
            console.log("✅ Firebase Initialized");

            // Cloud Data Listener
            const starCountRef = ref(db, 'sdet_dashboard');
            onValue(starCountRef, (snapshot) => {
                const data = snapshot.val();
                if(data) {
                    window.state = data;
                    // Ensure IDs exist (migration fix)
                    if(window.state.dsa && window.state.dsa.length > 0 && !window.state.dsa[0].id) { 
                        window.state.dsa = window.state.dsa.map((x,i) => ({...x, id: Date.now()+i})); 
                    }
                    window.render();
                    updateSyncStatus(true);
                } else {
                    // Cloud empty, save default
                    window.saveToCloud();
                }
            }, (error) => {
                console.error("Firebase Read Error:", error);
                updateSyncStatus(false);
                window.initDefault(); // Fallback if read fails
            });

        } catch(e) {
            console.log("ℹ️ Running in Offline Mode (LocalStorage).");
            window.initDefault(); // IMMEDIATE FALLBACK
            updateSyncStatus(false);
        }

        // Global Cloud Save Function
        window.saveToCloud = function() {
            if(firebaseActive && db) {
                document.getElementById('loading-spinner').classList.remove('hidden');
                set(ref(db, 'sdet_dashboard'), window.state).then(() => {
                    document.getElementById('loading-spinner').classList.add('hidden');
                }).catch(e => {
                    console.error("Save failed:", e);
                    document.getElementById('loading-spinner').classList.add('hidden');
                });
            }
        }

        function updateSyncStatus(connected) {
            const icon = document.getElementById('sync-status-icon');
            const text = document.getElementById('sync-status-text');
            if(icon && text) {
                if(connected) {
                    icon.className = "w-2 h-2 rounded-full bg-emerald-500 animate-pulse";
                    text.innerText = "Cloud Synced";
                } else {
                    icon.className = "w-2 h-2 rounded-full bg-slate-400";
                    text.innerText = "Offline Mode";
                }
            }
        }
    </script>
	
    <script>
        // --- DATA ENGINE (Default Data) ---
        // This is only used if Cloud is empty
        const dsa90Days = [
            { day: 1, topic: "Arrays (Basics)", task: "Build Array Permutation", link: "https://leetcode.com/problems/build-array-from-permutation/", pri: "Low" },
            { day: 1, topic: "Arrays (Basics)", task: "Running Sum 1D", link: "https://leetcode.com/problems/running-sum-of-1d-array/", pri: "Low" },
            { day: 2, topic: "Arrays (Conditions)", task: "Contains Duplicate", link: "https://leetcode.com/problems/contains-duplicate/", pri: "Low" },
            // ... (Includes days 1-10)
        ];
        for(let i=3; i<=90; i++) {
            let topic = i<30?"Arrays/Strings":i<50?"LinkedList/Stack":i<70?"Trees/Graph":"DP";
            dsa90Days.push({day: i, topic: topic, task: `Problem Day ${i}`, link: "#", pri: "Medium"});
        }
        const dsaWithIds = dsa90Days.map((x, i) => ({ ...x, id: Date.now() + i }));

        let state = {
            projects: [],
            dsa: dsaWithIds,
            dsaStatus: {}, 
            routine: [ {id: 1, time: "08:00", text: "Wake up"}, {id: 2, time: "08:30", text: "DSA Practice"}, {id: 3, time: "10:00", text: "Work"}, {id: 4, time: "20:00", text: "Learning"} ],
            healthHistory: {},
            todayHealth: []
        };

        // --- GLOBAL ACTIONS (Called by buttons) ---
        // Note: We override 'save' to call 'window.saveToCloud' defined in module
        function save() { 
            if(window.saveToCloud) window.saveToCloud(); 
            render(); 
        }

        function initDefault() {
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('en-IN', {weekday:'long', day:'numeric', month:'long'});
            render();
            router('dashboard');
        }

        // --- RENDERERS ---
        function render() {
            renderProjects('Work'); renderProjects('Epam'); renderProjects('Learning');
            renderDSA(); renderHealth(); renderStats();
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('en-IN', {weekday:'long', day:'numeric', month:'long'});
        }

        function renderStats() {
            let totalT=0, totalD=0; let clientT=0, clientD=0; let epamT=0, epamD=0; let learnT=0, learnD=0; let hiPri = [];
            state.projects.forEach(p => {
                p.subtasks.forEach(s => {
                    let prog = parseInt(s.progress)/100;
                    totalT++; totalD+=prog;
                    if(p.type === 'Work') { clientT++; clientD+=prog; }
                    if(p.type === 'Epam') { epamT++; epamD+=prog; }
                    if(p.type === 'Learning') { learnT++; learnD+=prog; }
                    if(s.priority === 'High' && s.progress < 100) hiPri.push({t: s.title, ctx: p.title});
                });
            });
            state.dsa.forEach(d => {
                totalT++; if(state.dsaStatus[d.id]) { totalD++; }
                if(d.pri === 'High' && !state.dsaStatus[d.id]) hiPri.push({t: d.task, ctx: `Day ${d.day} DSA`});
            });
            const getPct = (done, total) => total ? Math.round((done/total)*100) : 0;
            const dsaDone = Object.keys(state.dsaStatus).length;
            
            document.getElementById('stat-progress').innerText = `${getPct(totalD, totalT)}%`;
            document.getElementById('stat-dsa').innerText = `${dsaDone}/90`;
            document.getElementById('stat-client-pct').innerText = `${getPct(clientD, clientT)}%`;
            document.getElementById('stat-epam-pct').innerText = `${getPct(epamD, epamT)}%`;
            document.getElementById('stat-cert-pct').innerText = `${getPct(learnD, learnT)}%`;
            document.getElementById('stat-streak').innerText = `${Object.keys(state.healthHistory).length} Days`;
            
            const list = document.getElementById('focus-list');
            if(hiPri.length === 0) list.innerHTML = `<div class="text-slate-400 italic">No high priority items!</div>`;
            else list.innerHTML = hiPri.map(h => `<div class="flex justify-between items-center bg-orange-50 p-2 rounded border-l-2 border-orange-500 mb-2"><div><div class="font-bold text-sm text-slate-700">${h.t}</div><div class="text-xs text-slate-500">${h.ctx}</div></div><span class="text-[10px] font-bold bg-white px-2 py-1 rounded text-orange-600 border border-orange-100">HIGH</span></div>`).join('');
            updateCharts();
        }

        function renderDSA() {
            const tbody = document.getElementById('dsa-tbody'); tbody.innerHTML = '';
            const sorted = [...state.dsa].sort((a,b) => a.day - b.day);
            const grouped = sorted.reduce((acc, curr) => { acc[curr.day] = acc[curr.day] || []; acc[curr.day].push(curr); return acc; }, {});
            Object.keys(grouped).forEach(day => {
                tbody.innerHTML += `<tr class="bg-slate-50"><td colspan="6" class="p-2 font-bold text-xs text-slate-500 uppercase tracking-widest border-t border-b">Day ${day}</td></tr>`;
                grouped[day].forEach(d => {
                    const isDone = state.dsaStatus[d.id];
                    tbody.innerHTML += `<tr class="border-b hover:bg-white transition"><td class="p-3 font-mono text-xs text-slate-400">#${d.day}</td><td class="p-3 text-xs font-bold text-slate-600">${d.topic}</td><td class="p-3"><a href="${d.link}" target="_blank" class="text-emerald-600 hover:underline font-bold text-sm flex items-center gap-1"><i class="ph-bold ph-code"></i> ${d.task}</a></td><td class="p-3"><span class="text-[10px] px-2 py-1 rounded font-bold ${d.pri==='High'?'bg-red-100 text-red-600':d.pri==='Medium'?'bg-yellow-100 text-yellow-600':'bg-slate-100 text-slate-500'}">${d.pri}</span></td><td class="p-3 text-center"><button onclick="openEditDSAModal(${d.id})" class="text-slate-400 hover:text-blue-600"><i class="ph-bold ph-pencil-simple"></i></button></td><td class="p-3 text-center"><input type="checkbox" class="status-checkbox accent-emerald-500" ${isDone?'checked':''} onchange="toggleDSA(${d.id})"></td></tr>`;
                });
            });
            const doneCount = Object.keys(state.dsaStatus).length;
            document.getElementById('dsa-progress-text').innerText = `${Math.round((doneCount/state.dsa.length)*100)}%`;
        }

        function renderProjects(type) {
            const el = document.getElementById(`container-${type}`);
            const list = state.projects.filter(p => p.type === type);
            let color = type === 'Epam' ? 'pink' : type === 'Learning' ? 'purple' : 'blue';
            if(list.length === 0) { el.innerHTML = `<div class="p-8 border-2 border-dashed border-slate-300 rounded text-center text-slate-400">No items.</div>`; return; }
            el.innerHTML = list.map(p => {
                const total=p.subtasks.length, sum=p.subtasks.reduce((a,b)=>a+parseInt(b.progress),0); const pct = total?Math.round(sum/total):0;
                return `<div class="card p-6 relative group border-t-4 border-${color}-500"><button onclick="deleteProject(${p.id})" class="absolute top-4 right-4 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><i class="ph-bold ph-trash"></i></button><div class="flex justify-between mb-2"><h3 class="font-bold text-lg">${p.title}</h3><span class="font-bold text-${color}-600">${pct}%</span></div><div class="w-full bg-slate-100 rounded-full h-2 mb-4"><div class="bg-${color}-600 h-2 rounded-full transition-all" style="width:${pct}%"></div></div><div class="space-y-3">${p.subtasks.map((s, idx) => `<div class="flex items-center gap-2 bg-slate-50 p-2 rounded border border-slate-100"><div class="flex-1"><div class="flex justify-between text-xs mb-1"><span class="font-semibold text-slate-700">${s.title}</span><span class="text-[10px] px-1.5 rounded bg-slate-200 text-slate-500">${s.priority}</span></div><input type="range" class="w-full h-1 bg-slate-200 rounded appearance-none cursor-pointer accent-${color}-600" min="0" max="100" value="${s.progress}" onchange="updateSubtask(${p.id}, ${idx}, this.value)"></div><span class="text-xs w-8 text-right font-mono">${s.progress}%</span></div>`).join('')}</div><button onclick="openSubtaskModal(${p.id})" class="mt-4 w-full py-2 border border-dashed border-slate-300 text-slate-500 hover:bg-${color}-50 text-sm">+ Add Subtask</button></div>`;
            }).join('');
        }
        function renderHealth() {
            document.getElementById('health-today-list').innerHTML = state.routine.map(r => `<label class="flex items-center gap-3 p-3 bg-white border border-slate-100 rounded shadow-sm cursor-pointer hover:border-blue-300 transition"><input type="checkbox" class="w-5 h-5 accent-blue-600" ${state.todayHealth.includes(r.id)?'checked':''} onchange="toggleHealthItem(${r.id})"><span class="font-mono text-xs text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded">${r.time}</span><span class="text-sm font-medium ${state.todayHealth.includes(r.id)?'line-through text-slate-400':''}">${r.text}</span></label>`).join('');
            document.getElementById('health-history-body').innerHTML = Object.keys(state.healthHistory).sort().reverse().map(d => `<tr class="border-b"><td class="p-3 text-xs font-mono">${d}</td><td class="p-3 text-xs text-slate-500">${state.healthHistory[d].length}/${state.routine.length} done</td></tr>`).join('');
        }

        // --- ACTIONS ---
        function toggleHealthItem(id) { if(state.todayHealth.includes(id)) state.todayHealth=state.todayHealth.filter(i=>i!==id); else state.todayHealth.push(id); save(); }
        function saveHealthDay() { state.healthHistory[new Date().toISOString().split('T')[0]] = [...state.todayHealth]; save(); alert("Day Saved!"); }
        function toggleDSA(id) { if(state.dsaStatus[id]) delete state.dsaStatus[id]; else state.dsaStatus[id]=true; save(); }
        function updateSubtask(pid, idx, val) { state.projects.find(x=>x.id===pid).subtasks[idx].progress=val; save(); }
        function openProjectModal(type) { document.getElementById('modal-p-type').value=type; document.getElementById('modal-p-title').value=''; document.getElementById('modal-project').classList.remove('hidden'); }
        function saveProject() { const t=document.getElementById('modal-p-title').value; if(t) state.projects.push({id:Date.now(), title:t, type:document.getElementById('modal-p-type').value, subtasks:[]}); save(); closeModal('modal-project'); }
        function deleteProject(id) { if(confirm('Delete?')) { state.projects=state.projects.filter(p=>p.id!==id); save(); } }
        function openSubtaskModal(pid) { document.getElementById('modal-s-parent').value=pid; document.getElementById('modal-s-title').value=''; document.getElementById('modal-subtask').classList.remove('hidden'); }
        function saveSubtask() { const pid=parseInt(document.getElementById('modal-s-parent').value); const t=document.getElementById('modal-s-title').value; if(t) state.projects.find(p=>p.id===pid).subtasks.push({title:t, priority:document.getElementById('modal-s-priority').value, progress:0}); save(); closeModal('modal-subtask'); }
        function openRoutineModal() { document.getElementById('routine-editor-list').innerHTML = state.routine.map((r,i) => `<div class="flex gap-2 items-center routine-row"><input type="time" class="border p-2 rounded text-sm w-24" value="${r.time}"><input type="text" class="border p-2 rounded text-sm flex-1" value="${r.text}"><button onclick="this.parentElement.remove()" class="text-red-400"><i class="ph-bold ph-trash"></i></button></div>`).join(''); document.getElementById('modal-routine').classList.remove('hidden'); }
        function addRoutineItem() { const d=document.createElement('div'); d.className="flex gap-2 items-center routine-row"; d.innerHTML=`<input type="time" class="border p-2 rounded text-sm w-24"><input type="text" class="border p-2 rounded text-sm flex-1"><button onclick="this.parentElement.remove()" class="text-red-400"><i class="ph-bold ph-trash"></i></button>`; document.getElementById('routine-editor-list').appendChild(d); }
        function saveRoutineEdit() { state.routine=[]; document.querySelectorAll('.routine-row').forEach((r,i) => { const inps=r.querySelectorAll('input'); if(inps[1].value) state.routine.push({id:i+1, time:inps[0].value, text:inps[1].value}); }); save(); closeModal('modal-routine'); }
        function openAddDSAModal() { document.getElementById('modal-dsa-title').innerText = "Add New Problem"; document.getElementById('dsa-id').value = ""; document.getElementById('dsa-day').value = ""; document.getElementById('dsa-topic').value = ""; document.getElementById('dsa-name').value = ""; document.getElementById('dsa-link').value = ""; document.getElementById('dsa-priority').value = "Medium"; document.getElementById('modal-dsa').classList.remove('hidden'); }
        function openEditDSAModal(id) { const item = state.dsa.find(x => x.id === id); document.getElementById('modal-dsa-title').innerText = "Edit Problem"; document.getElementById('dsa-id').value = id; document.getElementById('dsa-day').value = item.day; document.getElementById('dsa-topic').value = item.topic; document.getElementById('dsa-name').value = item.task; document.getElementById('dsa-link').value = item.link; document.getElementById('dsa-priority').value = item.pri; document.getElementById('modal-dsa').classList.remove('hidden'); }
        function saveDSA() { const id = document.getElementById('dsa-id').value; const day = parseInt(document.getElementById('dsa-day').value); const topic = document.getElementById('dsa-topic').value; const task = document.getElementById('dsa-name').value; const link = document.getElementById('dsa-link').value; const pri = document.getElementById('dsa-priority').value; if(!task || !day) return; if(id) { const idx = state.dsa.findIndex(x => x.id == id); if(idx !== -1) { state.dsa[idx] = { ...state.dsa[idx], day, topic, task, link, pri }; } } else { state.dsa.push({ id: Date.now(), day, topic, task, link, pri }); } save(); closeModal('modal-dsa'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function router(view) { document.querySelectorAll('main > div[id^="view-"]').forEach(d => d.classList.add('hidden')); document.getElementById(`view-${view}`).classList.remove('hidden'); document.querySelectorAll('.sidebar-item').forEach(b => b.classList.remove('active', 'bg-slate-800')); document.getElementById(`nav-${view}`).classList.add('active'); if(view==='dashboard') updateCharts(); }

        function updateCharts() {
            const ctx = document.getElementById('chart-domain'); if(window.myChart) window.myChart.destroy();
            let w=0, l=0, e=0;
            state.projects.forEach(p => { const s=p.subtasks.reduce((a,b)=>a+parseInt(b.progress),0); const m=p.subtasks.length*100||1; const score = (s/m)*100; if(p.type==='Work') w+=score; else if(p.type==='Epam') e+=score; else l+=score; });
            const d = (Object.keys(state.dsaStatus).length/90)*100;
            window.myChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['Work', 'Epam', 'Learn', 'DSA'], datasets: [{ data: [w||1, e||1, l||1, d||1], backgroundColor: ['#3b82f6', '#ec4899', '#8b5cf6', '#10b981'] }] }, options: { maintainAspectRatio:false, plugins:{legend:{position:'right'}} } });
        }
        
        // Init (if firebase fails)
        if(!db) initDefault();
    </script>
</body>
</html>

